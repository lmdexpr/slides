---
marp: true
theme: uncover
_class: lead
paginate: true
---

## 継続は力なり

yuki @lmdexpr
2025-09-05

---

<!-- header: "継続は力なり @lmdexpr" --->
## 自己紹介

- Yuki Tajiri (@lmdexpr)
- 2025-02 より M3 基盤チームでソフトウェアエンジニア
- Software Design で「つまみぐい関数型プログラミング」連載中

---

## 継続は力なり

> 「継続は力なり」とは、**「すぐに結果が出なくても、諦めずにこつこつと努力を続ければ、いずれは目標を達成でき、大きな力になる」**という意味のことわざです。

(gemini より)

---

ではなくて、

---

継続 (計算機科学)

---

## 今回の**皆さんの**目標

1. 継続 (計算機科学) の概要を知る
2. 継続が"""力"""であることを理解する
3. 継続と聞くと「今、"継続"の話をしましたね？」という気持ちになる

---

## 継続 (計算機科学) とは

コールバック関数

---

## 継続 (計算機科学) とは

~~コールバック関数~~

残りの計算

---

🤔

---

## Q1 答えは？

`1 + 2 * 3 - 4`

---

## Q1 答えは？

`1 + 2 * 3 - 4`

-> `3`

---

## Q2 どうやって計算しましたか？

`1 + 2 * 3 - 4`

---

## Q2 どうやって計算しましたか？

`1 + [ 2 * 3 ] - 4`

---

## Q2 どうやって計算しましたか？

`1 + [ 2 * 3 ] - 4`

→ `1 + [ 6 ] - 4`

---

## Q2 どうやって計算しましたか？

`1 + [ 2 * 3 ] - 4`

→ `1 + [ 6 ] - 4`

→ `[ 1 + 6 ] - 4`

---

## Q2 どうやって計算しましたか？

`1 + [ 2 * 3 ] - 4`

→ `1 + [ 6 ] - 4`

→ `[ 1 + 6 ] - 4`

→ `[ 7 ] - 4`

---

## Q2 どうやって計算しましたか？

`1 + [ 2 * 3 ] - 4`

→ `1 + [ 6 ] - 4`

→ `[ 1 + 6 ] - 4`

→ `[ 7 ] - 4`

→ `[ 7 - 4 ]`

---

## Q2 どうやって計算しましたか？

`1 + [ 2 * 3 ] - 4`

→ `1 + [ 6 ] - 4`

→ `[ 1 + 6 ] - 4`

→ `[ 7 ] - 4`

→ `[ 7 - 4 ]`

→ `[ 3 ]`

---

つまり、計算には「順序」がある。

---

つまり、計算には「順序」がある。

-> 「今計算しているもの」と「残りの計算」がある。

---

## 継続はコールバック関数？

`1 + 2 * 3 - 4` を考えると、

→ `1 + [2 * 3] - 4`

→ 継続は `1 + [・] - 4`

---

## 継続はコールバック関数？

`1 + [・] - 4`

=> `[・]` が与えられると残りの計算が実行される関数と見れる

---

## 継続はコールバック関数？

`1 + [・] - 4`

=> JavaScript なら

```js
const rest = (x) => 1 + x - 4;
```

---

## 継続はコールバック関数？

継続が取り出せたので使ってみる

```js
const rest = (x) => 1 + x - 4;

// 継続は慣例的に k で表すことが多い
const f = (k) => k(2 * 3);

console.log(f(rest))
```

---

## 継続はコールバック関数？

コールバック関数だ！

---

🤔「なんとなく継続は分かったけど何の役に立つんだ？」

---

## 継続は遍在する

継続で実装できるもの

- ループ脱出
- ループ
- コルーチン、マイクロスレッド、ジェネレータ
- バックトラッキング
- 例外処理
- 全てのモナド

---

## 継続は遍在する

なんでもできる

---

## 継続してみる

ある処理を direct-style から continuation-passing-style (CPS) に変換できます。

---

## 継続してみる

ある処理を direct-style から continuation-passing-style (CPS) に変換できます。

```js
// direct-style
const add5 = (x) => x + 5;
const mul3 = (x) => x * 3;

console.log(add5(mul3(7))) // → 26
```

---

## 継続してみる

ある処理を direct-style から continuation-passing-style (CPS) に変換できます。

```js
// continuation-passing-style
const add5 = (x) => (k) => k(x + 5);
const mul3 = (x) => (k) => k(x * 3);

mul3(7)(add5)(console.log); // → 26
```

---

## 継続してみる

- 実は、機械的に direct-style から CPS へ変換することが可能
  - 関数型言語や論理型言語では中間表現として CPS 変換されることもある
- モナドにおける do 記法は CPS から direct-style への変換
  - map/flatMap が CPS になっているため

---

## 継続してみる (余談)

- 一部の言語 (Scheme, Ruby, ...) には継続に関する操作があります
  - 特に、Scheme では継続が第一級オブジェクトです
- 操作として `call/cc`、`shift`/`reset` など複数あります
  - 後者は「限定継続」と呼ばれるもの
  - （限定でない）「継続」は強力すぎるので使いづらい
  - 「継続」と「限定継続」は同値

---

## まとめ

- 継続は「残りの計算」
- あらゆるものを実装できる
- 特に、関数型や論理型と相性が良い
- 手続型や OOP でも遍在している
- 意識的に変換することもできる

---

ところで、

---

なぜ今更こんな話を？

---

次回
「継続の効果、あるいは、継続と効果」（仮）

---

## 参考資料

詳しいことは以下の資料を読んでください。

- SICP https://sicp.iijlab.net/
- shift/reset プログラミング入門 http://pllab.is.ocha.ac.jp/~asai/cw2011tutorial/main-j.pdf
